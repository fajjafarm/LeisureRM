<?php namespace App\Models; use Illuminate\Database\Eloquent\Model; use Spatie\Activitylog\Traits\LogsActivity; use Spatie\Activitylog\LogOptions; class PoolTest extends Model { use LogsActivity; protected $fillable=["sub_facility_id","user_id","temperature","ph","chlorine","alkalinity","calcium_hardness","tds","notes","saturation_index"]; public function subFacility(){return $this->belongsTo(SubFacility::class);} public function user(){return $this->belongsTo(User::class);} public function getActivitylogOptions(): LogOptions { return LogOptions::defaults()->logOnlyDirty(); } protected static function booted(){ static::saving(function($t){ $t->saturation_index = $t->calculateLSI(); if($t->isDirty() && auth()->user()?->rankPriority() >= 4){ activity()->on($t)->withProperties(["reason"=>request("edit_reason") ?? "No reason"])->log("Pool test edited by manager"); } }); } public function calculateLSI(): float { $temp=$this->temperature; $tf=match(true){$temp<32=>0.0,$temp<37=>0.1,$temp<46=>0.2,$temp<53=>0.3,$temp<60=>0.4,$temp<66=>0.5,$temp<76=>0.6,$temp<84=>0.7,$temp<94=>0.8,$temp<105=>0.9,default=>1.0}; $cf=log10($this->calcium_hardness)-1; $af=log10($this->alkalinity)-0.15; return round($this->ph + $tf + $cf + $af - 12.1, 2); } }
